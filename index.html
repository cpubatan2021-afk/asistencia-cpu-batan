<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Control de Asistencia - Comunidad Pastoral Universitaria Bat√°n</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-analytics-compat.js"></script>
    <style>
        :root {
            --bg-dark: #0f172a;
            --bg-light: #1e293b;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --accent: #6366f1;
            --accent-secondary: #8b5cf6;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --border-radius: 0.5rem;
            --font-family: 'Poppins', sans-serif;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: var(--font-family);
        }
        body {
            background-color: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 0.5rem;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }
        .container {
            max-width: 100%;
            margin: 0 auto;
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            width: 100%;
            overflow-x: auto;
        }
        /* Header */
        .header {
            background: linear-gradient(135deg, var(--bg-light), #334155);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            text-align: center;
            box-shadow: var(--shadow);
            position: relative;
            margin-bottom: 1rem;
        }
        .header-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        .header h1 {
            color: var(--accent);
            font-size: 2rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
        }
        .logo-cpu {
            width: 2.5rem;
            height: auto;
            filter: drop-shadow(0 0 8px rgba(99, 102, 241, 0.7));
        }
        .clock {
            font-size: 0.8rem;
            color: var(--text-secondary);
            background-color: rgba(0, 0, 0, 0.3);
            padding: 0.5rem;
            border-radius: 0.375rem;
            font-family: monospace;
            margin-top: 0.5rem;
        }
        .logout-btn-container {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
        }

        /* Carrusel */
        .carrusel-container {
            position: relative;
            max-width: 100%;
            margin: 1rem auto;
            overflow: hidden;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            background-color: var(--bg-light);
            height: 120px;
        }
        .carrusel {
            display: flex;
            height: 100%;
            transition: transform 0.5s ease;
        }
        .carrusel-item {
            min-width: 100%;
            padding: 1rem;
            text-align: center;
            color: var(--text-primary);
            background: linear-gradient(135deg, var(--bg-light), #334155);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .carrusel-item h3 {
            color: var(--accent);
            font-size: 1rem;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        .carrusel-item p {
            color: var(--text-secondary);
            font-size: 0.85rem;
            font-style: italic;
        }
        .carrusel-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            padding: 0.5rem;
            cursor: pointer;
            border-radius: 50%;
            font-size: 1.2rem;
            z-index: 10;
            transition: var(--transition);
        }
        .carrusel-btn:hover {
            background-color: rgba(0, 0, 0, 0.8);
        }
        .carrusel-btn.prev {
            left: 0.5rem;
        }
        .carrusel-btn.next {
            right: 0.5rem;
        }

        /* Layout */
        .layout {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            flex: 1;
            overflow-x: auto;
        }
        /* Sidebar */
        .sidebar {
            background-color: var(--bg-light);
            border-radius: var(--border-radius);
            padding: 1rem;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .sidebar h2 {
            color: var(--accent);
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }
        /* Materia List */
        .materia-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            max-height: 50vh;
            overflow-y: auto;
            padding-right: 0.5rem;
        }
        .materia-item {
            position: relative;
        }
        .materia-btn {
            width: 100%;
            padding: 0.75rem;
            background-color: var(--accent-secondary);
            color: white;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: 500;
            text-align: left;
            transition: var(--transition);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .materia-btn.active {
            background-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.3);
        }
        .materia-btn:hover:not(.active) {
            background-color: #7c3aed;
        }
        .delete-materia {
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.3);
            border: none;
            color: white;
            width: 1.5rem;
            height: 1.5rem;
            border-radius: 50%;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
        }
        /* Buttons */
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-size: 0.85rem;
        }
        .btn-primary {
            background-color: var(--accent);
            color: white;
        }
        .btn-primary:hover {
            background-color: #5856eb;
        }
        .btn-success {
            background-color: var(--success);
            color: white;
        }
        .btn-success:hover {
            background-color: #0d9488;
        }
        .btn-danger {
            background-color: var(--danger);
            color: white;
        }
        .btn-danger:hover {
            background-color: #dc2626;
        }
        .btn-warning {
            background-color: var(--warning);
            color: white;
        }
        .btn-warning:hover {
            background-color: #d97706;
        }
        .btn-block {
            width: 100%;
        }
        /* Content */
        .content {
            background-color: var(--bg-light);
            border-radius: var(--border-radius);
            padding: 1rem;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            gap: 1rem;
            overflow-x: auto;
        }
        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 1px solid #475569;
            margin-bottom: 1rem;
        }
        .tab {
            padding: 0.5rem 1rem;
            cursor: pointer;
            background-color: transparent;
            border: none;
            color: var(--text-secondary);
            font-weight: 500;
            transition: var(--transition);
            border-bottom: 2px solid transparent;
            font-size: 0.9rem;
        }
        .tab.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }
        .tab:hover:not(.active) {
            color: var(--text-primary);
        }
        /* Tables */
        .table-container {
            overflow-x: auto;
            max-width: 100%;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
            box-shadow: var(--shadow);
            border-radius: var(--border-radius);
            overflow: hidden;
            font-size: 0.75rem;
            min-width: 600px;
        }
        thead {
            background-color: var(--accent);
            color: white;
        }
        th, td {
            padding: 0.5rem;
            text-align: left;
            border-bottom: 1px solid #475569;
            white-space: nowrap;
        }
        tr:hover {
            background-color: rgba(99, 102, 241, 0.1);
        }
        /* Modals */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
        }
        .modal-content {
            background-color: var(--bg-light);
            margin: 10% auto;
            padding: 1.5rem;
            border-radius: var(--border-radius);
            border: 1px solid var(--accent);
            width: 95%;
            max-width: 500px;
            box-shadow: var(--shadow);
            position: relative;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid #475569;
        }
        .modal-title {
            color: var(--accent);
            font-size: 1.25rem;
            font-weight: 600;
        }
        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.25rem;
            cursor: pointer;
            transition: var(--transition);
        }
        .modal-close:hover {
            color: var(--text-primary);
        }
        .modal-body {
            margin-bottom: 1rem;
        }
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }
        /* Estad√≠sticas */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .stat-card {
            background: linear-gradient(135deg, var(--bg-light), #334155);
            padding: 1rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            text-align: center;
        }
        .stat-card h4 {
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-bottom: 0.5rem;
        }
        .stat-card p {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
        }
        /* Footer */
        .footer {
            background-color: var(--bg-light);
            padding: 1rem;
            text-align: center;
            border-radius: var(--border-radius);
            margin-top: 1rem;
            box-shadow: var(--shadow);
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        .footer a {
            color: var(--accent);
            text-decoration: none;
        }
        .footer a:hover {
            text-decoration: underline;
        }
        /* Login Modal */
        .login-modal {
            display: flex;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
        }
        .login-modal-content {
            background-color: var(--bg-light);
            margin: auto;
            padding: 1.5rem;
            border-radius: var(--border-radius);
            border: 1px solid var(--accent);
            width: 90%;
            max-width: 350px;
            text-align: center;
            box-shadow: var(--shadow);
        }
        /* Responsive */
        @media (min-width: 768px) {
            .layout {
                grid-template-columns: 300px 1fr;
                gap: 1.5rem;
            }
            .header h1 {
                font-size: 2.2rem;
            }
            .sidebar {
                padding: 1.5rem;
            }
            .sidebar h2 {
                font-size: 1.3rem;
            }
            .materia-btn {
                padding: 0.75rem;
                font-size: 1rem;
            }
            .content {
                padding: 1.5rem;
            }
            table {
                font-size: 0.9rem;
            }
            th, td {
                padding: 0.75rem 1rem;
            }
        }
        .hidden {
            display: none;
        }
        select, input[type="text"], input[type="date"], textarea {
            width: 100%;
            padding: 0.5rem;
            border-radius: 0.5rem;
            border: 1px solid #475569;
            background-color: #2d3748;
            color: var(--text-primary);
            font-size: 0.9rem;
        }
    </style>
</head>
<body onload="init()">
    <!-- Firebase Configuration -->
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCgg_9oBHyr5ouu8WUYVokD0JWIvnA1oj0",
            authDomain: "cpu-batan.firebaseapp.com",
            databaseURL: "https://cpu-batan-default-rtdb.firebaseio.com",
            projectId: "cpu-batan",
            storageBucket: "cpu-batan.appspot.com",
            messagingSenderId: "513877189909",
            appId: "1:513877189909:web:1d186224b1ecb7bf7e751c",
            measurementId: "G-Y0SCDERTK3"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
    </script>

    <!-- Login Modal -->
    <div id="loginModal" class="login-modal">
        <div class="login-modal-content">
            <h3>üîê Iniciar Sesi√≥n</h3>
            <input type="password" id="loginPassword" placeholder="Contrase√±a de administrador" class="btn-block" style="margin-bottom: 1rem;">
            <div class="modal-footer">
                <button class="btn btn-primary btn-block" onclick="login()">Ingresar</button>
            </div>
        </div>
    </div>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <h1>
                    CPU Bat√°n
                    <img src="https://raw.githubusercontent.com/cpubatan2021-afk/asistencia-cpu-batan/main/image%20(1).png" alt="Logo CPU" class="logo-cpu">
                </h1>
                <p>üìö Control de Asistencia</p>
            </div>
            <div class="clock" id="clock"></div>
            <div class="logout-btn-container">
                <button id="logoutBtn" class="btn btn-danger" style="padding: 0.3rem 0.75rem; font-size: 0.75rem;" onclick="logout()">Cerrar Sesi√≥n</button>
            </div>
        </div>

        <!-- Carrusel -->
        <div class="carrusel-container">
            <div class="carrusel">
                <div class="carrusel-item active">
                    <h3>"La cultura es el espejo de una comunidad."</h3>
                    <p>‚Äî An√≥nimo</p>
                </div>
                <div class="carrusel-item">
                    <h3>"La comunidad es el coraz√≥n de la sociedad."</h3>
                    <p>‚Äî An√≥nimo</p>
                </div>
                <div class="carrusel-item">
                    <h3>"La diversidad cultural enriquece a la comunidad."</h3>
                    <p>‚Äî An√≥nimo</p>
                </div>
                <div class="carrusel-item">
                    <h3>"Una comunidad unida es una comunidad fuerte."</h3>
                    <p>‚Äî An√≥nimo</p>
                </div>
                <div class="carrusel-item">
                    <h3>"La cultura es la identidad de un pueblo."</h3>
                    <p>‚Äî An√≥nimo</p>
                </div>
                <div class="carrusel-item">
                    <h3>"La educaci√≥n es la base de una comunidad pr√≥spera."</h3>
                    <p>‚Äî An√≥nimo</p>
                </div>
                <div class="carrusel-item">
                    <h3>"La solidaridad construye comunidades resilientes."</h3>
                    <p>‚Äî An√≥nimo</p>
                </div>
                <div class="carrusel-item">
                    <h3>"La cultura es el legado que dejamos a las futuras generaciones."</h3>
                    <p>‚Äî An√≥nimo</p>
                </div>
                <div class="carrusel-item">
                    <h3>"La participaci√≥n activa fortalece a la comunidad."</h3>
                    <p>‚Äî An√≥nimo</p>
                </div>
                <div class="carrusel-item">
                    <h3>"La comunidad es el lugar donde todos pertenecemos."</h3>
                    <p>‚Äî An√≥nimo</p>
                </div>
            </div>
            <button class="carrusel-btn prev" onclick="moveCarrusel(-1)">‚ùÆ</button>
            <button class="carrusel-btn next" onclick="moveCarrusel(1)">‚ùØ</button>
        </div>

        <!-- Layout -->
        <div class="layout">
            <!-- Sidebar -->
            <div class="sidebar">
                <h2>üìã Materias</h2>
                <div>
                    <select id="tipoMateria" class="btn-block" onchange="render()">
                        <option value="extension">Extensi√≥n Universitaria</option>
                        <option value="taller">Taller Universitario</option>
                    </select>
                </div>
                <div>
                    <select id="mesSelector" class="btn-block" onchange="cambiarMes()">
                        <option value="0">Enero</option>
                        <option value="1">Febrero</option>
                        <option value="2">Marzo</option>
                        <option value="3">Abril</option>
                        <option value="4">Mayo</option>
                        <option value="5">Junio</option>
                        <option value="6">Julio</option>
                        <option value="7">Agosto</option>
                        <option value="8">Septiembre</option>
                        <option value="9">Octubre</option>
                        <option value="10">Noviembre</option>
                        <option value="11">Diciembre</option>
                    </select>
                </div>
                <div class="materia-list" id="materiasList"></div>
                <button id="btnNuevaMateria" class="btn btn-primary btn-block" onclick="mostrarModalTipoMateria()">‚ûï Nueva Materia</button>
                <button id="btnNuevoAlumno" class="btn btn-primary btn-block" onclick="mostrarFormularioAlumno()">‚ûï Nuevo Alumno</button>
            </div>
            <!-- Content -->
            <div class="content">
                <!-- Tabs -->
                <div class="tabs">
                    <button class="tab active" onclick="cambiarPestania('asistencia')">Asistencia</button>
                    <button class="tab" onclick="cambiarPestania('estadisticas')">Estad√≠sticas</button>
                </div>
                <!-- Asistencia Tab -->
                <div id="asistencia" class="tab-content">
                    <div id="alumnoFormContainer" class="hidden" style="background: linear-gradient(135deg, #2d3748, #4a5568); padding: 1rem; border-radius: var(--border-radius); margin-bottom: 1rem; box-shadow: var(--shadow);">
                        <h3 style="color: var(--accent); margin-bottom: 0.75rem;">‚ûï Agregar Nuevo Alumno</h3>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; margin-bottom: 0.75rem;">
                            <input type="text" id="fn" placeholder="Nombre">
                            <input type="text" id="fa" placeholder="Apellido">
                            <input type="text" id="fd" placeholder="DNI">
                            <input type="text" id="fp" placeholder="Pabell√≥n">
                        </div>
                        <div style="margin-bottom: 0.75rem;">
                            <h4 style="margin-bottom: 0.5rem;">Seleccionar Materias:</h4>
                            <div id="materiasCheckboxContainer" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; max-height: 150px; overflow-y: auto; padding: 0.5rem; background-color: #2d3748; border-radius: 0.5rem; border: 1px solid var(--accent);"></div>
                        </div>
                        <button class="btn btn-success btn-block" onclick="addAlumno()">Agregar Alumno</button>
                    </div>
                    <div class="table-container">
                        <div id="mainArea"></div>
                    </div>
                </div>
                <!-- Estad√≠sticas Tab -->
                <div id="estadisticas" class="tab-content hidden">
                    <div style="display: flex; flex-direction: column; gap: 0.75rem; margin-bottom: 1rem;">
                        <select id="estadisticasSemestreSelector" onchange="cargarMateriasEstadisticas()">
                            <option value="primer">Primer Semestre</option>
                            <option value="segundo">Segundo Semestre</option>
                        </select>
                        <select id="estadisticasTipoMateria" onchange="cargarMateriasEstadisticas()">
                            <option value="extension">Extensi√≥n Universitaria</option>
                            <option value="taller">Taller Universitario</option>
                        </select>
                        <select id="estadisticasMateriaSelector" onchange="cargarEstadisticas()">
                            <option value="">Selecciona una materia</option>
                        </select>
                    </div>
                    <div id="estadisticasContainer"></div>
                </div>
            </div>
        </div>
        <!-- Footer -->
        <div class="footer">
            <p>Programa desarrollado por <strong>Daniel Fiego</strong> para la <strong>Comunidad Pastoral Universitaria de Bat√°n</strong>.</p>
            <p>¬© 2025 Todos los derechos reservados.</p>
        </div>
    </div>
    <!-- Modals -->
    <!-- Modal Tipo Materia -->
    <div id="modalTipoMateria" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Selecciona el tipo de materia</h3>
                <button class="modal-close" onclick="cerrarModal('modalTipoMateria')">√ó</button>
            </div>
            <div class="modal-body" style="display: flex; justify-content: center; gap: 0.75rem;">
                <button class="btn btn-primary" style="flex: 1;" onclick="seleccionarTipoMateria('extension')">Extensi√≥n Universitaria</button>
                <button class="btn" style="flex: 1; background-color: var(--accent-secondary);" onclick="seleccionarTipoMateria('taller')">Taller Universitario</button>
            </div>
        </div>
    </div>
    <!-- Modal Nueva Materia -->
    <div id="modalMateria" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Nueva Materia</h3>
                <button class="modal-close" onclick="cerrarModal('modalMateria')">√ó</button>
            </div>
            <div class="modal-body">
                <input type="text" id="nombreMateria" placeholder="Nombre de la materia" style="width: 100%; margin-bottom: 1rem;">
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="cerrarModal('modalMateria')">Cancelar</button>
                <button class="btn btn-success" onclick="crearMateria()">Confirmar</button>
            </div>
        </div>
    </div>
    <!-- Modal Eliminar Materia -->
    <div id="modalEliminarMateria" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">¬øEliminar esta materia?</h3>
                <button class="modal-close" onclick="cerrarModal('modalEliminarMateria')">√ó</button>
            </div>
            <div class="modal-body">
                <p id="nombreMateriaEliminar" style="text-align: center; font-size: 1rem; margin-bottom: 1rem;"></p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="cerrarModal('modalEliminarMateria')">Cancelar</button>
                <button class="btn btn-success" onclick="confirmarEliminarMateria()">Confirmar</button>
            </div>
        </div>
    </div>
    <!-- Modal Editar Alumno -->
    <div id="modalEditarAlumno" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Editar Alumno</h3>
                <button class="modal-close" onclick="cerrarModal('modalEditarAlumno')">√ó</button>
            </div>
            <div class="modal-body">
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; margin-bottom: 0.75rem;">
                    <input type="text" id="editNombre" placeholder="Nombre">
                    <input type="text" id="editApellido" placeholder="Apellido">
                    <input type="text" id="editDNI" placeholder="DNI">
                    <input type="text" id="editPabellon" placeholder="Pabell√≥n">
                </div>
                <div style="margin-bottom: 0.75rem;">
                    <label for="editFechaInscripcion" style="display: block; margin-bottom: 0.3rem;">Fecha de Inscripci√≥n:</label>
                    <input type="date" id="editFechaInscripcion" style="width: 100%;">
                </div>
                <div style="margin-bottom: 0.75rem;">
                    <label for="editFechaVencimiento" style="display: block; margin-bottom: 0.3rem;">Fecha de Vencimiento:</label>
                    <input type="date" id="editFechaVencimiento" style="width: 100%;">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="cerrarModal('modalEditarAlumno')">Cancelar</button>
                <button class="btn btn-success" onclick="guardarEdicionAlumno()">Guardar</button>
            </div>
        </div>
    </div>
    <script>
        // Variables globales
        var userRole = 'espectador'; // 'espectador' o 'admin'
        var db = {
            meses: [],
            tipoMateriaActual: 'extension',
            tipoMateriaSeleccionado: null,
            mesActual: 0,
            materiaAEliminar: null,
            alumnoAEditar: null,
            actual: null
        };

        // Variables para el carrusel
        let currentCarruselIndex = 0;
        let carruselItems;
        let carrusel;

        // Funci√≥n para mover el carrusel
        function moveCarrusel(n) {
            currentCarruselIndex += n;
            if (currentCarruselIndex >= carruselItems.length) {
                currentCarruselIndex = 0;
            } else if (currentCarruselIndex < 0) {
                currentCarruselIndex = carruselItems.length - 1;
            }
            carrusel.style.transform = `translateX(-${currentCarruselIndex * 100}%)`;
        }

        // Inicializar la base de datos
        function initDB() {
            database.ref('meses').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    db.meses = data;
                } else {
                    // Si no hay datos, inicializar con estructura vac√≠a
                    db.meses = [];
                    for (let i = 0; i < 12; i++) {
                        db.meses.push({
                            id: i,
                            materias: [],
                            alumnos: []
                        });
                    }
                    // Guardar estructura inicial en Firebase
                    database.ref('meses').set(db.meses);
                }
                render();
            });
        }

        // Inicializar la aplicaci√≥n
        function init() {
            initDB();
            db.mesActual = parseInt(document.getElementById('mesSelector').value);
            updateClock();
            setInterval(updateClock, 1000);
            document.getElementById('loginModal').style.display = 'flex';

            // Inicializar carrusel
            carruselItems = document.querySelectorAll('.carrusel-item');
            carrusel = document.querySelector('.carrusel');
            setInterval(() => {
                moveCarrusel(1);
            }, 5000);
        }

        // Actualizar el reloj
        function updateClock() {
            const now = new Date();
            const options = {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            };
            document.getElementById('clock').textContent = now.toLocaleDateString('es-ES', options);
        }

        // Login
        function login() {
            const password = document.getElementById('loginPassword').value;
            if (password === 'admin123') {
                userRole = 'admin';
            } else {
                userRole = 'espectador';
            }
            document.getElementById('loginPassword').value = '';
            document.getElementById('loginModal').style.display = 'none';
            render();
        }

        // Logout
        function logout() {
            userRole = 'espectador';
            document.getElementById('loginModal').style.display = 'flex';
            render();
        }

        // Mostrar modal para elegir tipo de materia
        function mostrarModalTipoMateria() {
            if (userRole !== 'admin') {
                alert('Solo los administradores pueden crear materias.');
                return;
            }
            document.getElementById('modalTipoMateria').style.display = 'block';
        }

        // Seleccionar tipo de materia
        function seleccionarTipoMateria(tipo) {
            db.tipoMateriaSeleccionado = tipo;
            cerrarModal('modalTipoMateria');
            mostrarModalMateria();
        }

        // Mostrar modal para nueva materia
        function mostrarModalMateria() {
            document.getElementById('modalMateria').style.display = 'block';
        }

        // Cerrar modal
        function cerrarModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        // Crear una nueva materia
        function crearMateria() {
            var nom = document.getElementById('nombreMateria').value.trim();
            if (!nom) {
                alert('Ingresa un nombre para la materia');
                return;
            }
            var mesSeleccionado = parseInt(document.getElementById('mesSelector').value);
            const newMateria = {
                id: Date.now(),
                nombre: nom,
                tipo: db.tipoMateriaSeleccionado,
                fechas: [],
                alumnos: []
            };

            // Agregar a la base de datos local
            db.meses[mesSeleccionado].materias.push(newMateria);

            // Guardar en Firebase
            database.ref(`meses/${mesSeleccionado}/materias`).set(db.meses[mesSeleccionado].materias);

            cerrarModal('modalMateria');
            document.getElementById('nombreMateria').value = '';
            render();
        }

        // Mostrar modal para eliminar materia
        function mostrarModalEliminarMateria(id) {
            if (userRole !== 'admin') {
                alert('Solo los administradores pueden eliminar materias.');
                return;
            }
            var mesSeleccionado = parseInt(document.getElementById('mesSelector').value);
            var materia = db.meses[mesSeleccionado].materias.find(m => m.id === id);
            if (!materia) {
                alert('Materia no encontrada.');
                return;
            }
            document.getElementById('nombreMateriaEliminar').textContent = materia.nombre;
            db.materiaAEliminar = id;
            document.getElementById('modalEliminarMateria').style.display = 'block';
        }

        // Confirmar eliminaci√≥n de materia
        function confirmarEliminarMateria() {
            var mesSeleccionado = parseInt(document.getElementById('mesSelector').value);
            var materiasMesActual = db.meses[mesSeleccionado].materias;
            if (materiasMesActual.length === 1) {
                alert('Debe haber al menos una materia en el mes seleccionado.');
                return;
            }
            db.meses[mesSeleccionado].materias = materiasMesActual.filter(m => m.id !== db.materiaAEliminar);

            // Guardar en Firebase
            database.ref(`meses/${mesSeleccionado}/materias`).set(db.meses[mesSeleccionado].materias);

            cerrarModal('modalEliminarMateria');
            render();
        }

        // Ver una materia espec√≠fica
        function verMateria(id) {
            db.actual = id;
            document.getElementById('alumnoFormContainer').classList.add('hidden');
            document.getElementById('mainArea').classList.remove('hidden');
            render();
        }

        // Mostrar el formulario para agregar alumno
        function mostrarFormularioAlumno() {
            if (userRole !== 'admin') {
                alert('Solo los administradores pueden agregar alumnos.');
                return;
            }
            var mesSeleccionado = parseInt(document.getElementById('mesSelector').value);
            var tipoSeleccionado = document.getElementById('tipoMateria').value;
            var materiasMesActual = db.meses[mesSeleccionado].materias.filter(m => m.tipo === tipoSeleccionado);
            var checkboxesHtml = '';
            materiasMesActual.forEach(m => {
                checkboxesHtml += `
                    <div style="display: flex; align-items: center; gap: 0.3rem;">
                        <input type="checkbox" id="materia-${m.id}" value="${m.id}">
                        <label for="materia-${m.id}" style="font-size: 0.8rem;">${m.nombre}</label>
                    </div>
                `;
            });
            document.getElementById('materiasCheckboxContainer').innerHTML = checkboxesHtml;
            document.getElementById('alumnoFormContainer').classList.remove('hidden');
            document.getElementById('mainArea').classList.add('hidden');
        }

        // Ocultar el formulario de alumno
        function ocultarFormularioAlumno() {
            document.getElementById('alumnoFormContainer').classList.add('hidden');
            document.getElementById('mainArea').classList.remove('hidden');
        }

        // Agregar un alumno
        function addAlumno() {
            var n = document.getElementById('fn').value.trim();
            var a = document.getElementById('fa').value.trim();
            var d = document.getElementById('fd').value.trim();
            var p = document.getElementById('fp').value.trim();
            var checkboxes = document.querySelectorAll('#materiasCheckboxContainer input[type="checkbox"]:checked');
            var materiasSeleccionadas = Array.from(checkboxes).map(cb => parseInt(cb.value));

            if (!n || !a || !d || !p || materiasSeleccionadas.length === 0) {
                alert('Completa todos los campos y selecciona al menos una materia');
                return;
            }

            var mesSeleccionado = parseInt(document.getElementById('mesSelector').value);

            // Inicializar db.meses[mesSeleccionado].alumnos si no existe
            if (!db.meses[mesSeleccionado].alumnos) {
                db.meses[mesSeleccionado].alumnos = [];
            }

            // Verificar si el alumno ya existe
            let alumnoExistente = db.meses[mesSeleccionado].alumnos.find(al => al.dni === d);

            // Si no existe, crear un nuevo alumno
            if (!alumnoExistente) {
                let hoy = new Date().toISOString().split('T')[0];
                let unAnoDespues = new Date();
                unAnoDespues.setFullYear(unAnoDespues.getFullYear() + 1);
                let vencimiento = unAnoDespues.toISOString().split('T')[0];
                alumnoExistente = {
                    id: Date.now(),
                    nombre: n,
                    apellido: a,
                    dni: d,
                    pabellon: p,
                    fecha_inscripcion: hoy,
                    fecha_vencimiento_carnet: vencimiento
                };
                db.meses[mesSeleccionado].alumnos.push(alumnoExistente);
            }

            // Agregar el alumno a las materias seleccionadas
            materiasSeleccionadas.forEach(mid => {
                let materia = db.meses[mesSeleccionado].materias.find(m => m.id === mid);
                if (materia) {
                    // Inicializar materia.alumnos si no existe
                    if (!materia.alumnos) {
                        materia.alumnos = [];
                    }
                    // Verificar si el alumno ya est√° en la materia
                    if (!materia.alumnos.some(al => al.id === alumnoExistente.id)) {
                        materia.alumnos.push({
                            id: alumnoExistente.id,
                            nombre: alumnoExistente.nombre,
                            apellido: alumnoExistente.apellido,
                            dni: alumnoExistente.dni,
                            pabellon: alumnoExistente.pabellon,
                            fecha_inscripcion: alumnoExistente.fecha_inscripcion,
                            fecha_vencimiento_carnet: alumnoExistente.fecha_vencimiento_carnet,
                            asist: {},
                            observaciones: ''
                        });
                    }
                }
            });

            // Guardar en Firebase
            database.ref(`meses/${mesSeleccionado}`).set(db.meses[mesSeleccionado]);

            // Limpiar formulario
            document.getElementById('fn').value = '';
            document.getElementById('fa').value = '';
            document.getElementById('fd').value = '';
            document.getElementById('fp').value = '';
            ocultarFormularioAlumno();
            render();
        }

        // Eliminar un alumno
        function delAlumno(mid, aid) {
            if (userRole !== 'admin') {
                alert('Solo los administradores pueden eliminar alumnos.');
                return;
            }
            if (confirm('¬øEliminar alumno?')) {
                var mesSeleccionado = parseInt(document.getElementById('mesSelector').value);
                var mat = db.meses[mesSeleccionado].materias.find(m => m.id === mid);
                if (mat) {
                    mat.alumnos = mat.alumnos.filter(a => a.id !== aid);

                    // Guardar en Firebase
                    database.ref(`meses/${mesSeleccionado}/materias`).set(db.meses[mesSeleccionado].materias);

                    render();
                }
            }
        }

        // Agregar una nueva fecha/clase
        function addFecha() {
            if (userRole !== 'admin') {
                alert('Solo los administradores pueden agregar fechas.');
                return;
            }
            var f = prompt('Ingresa el nombre de la nueva fecha/clase:');
            if (!f) return;
            var mesSeleccionado = parseInt(document.getElementById('mesSelector').value);
            var mat = db.meses[mesSeleccionado].materias.find(m => m.id === db.actual);
            if (mat) {
                mat.fechas.push(f);

                // Guardar en Firebase
                database.ref(`meses/${mesSeleccionado}/materias`).set(db.meses[mesSeleccionado].materias);

                render();
            }
        }

        // Eliminar una fecha/clase
        function deleteFecha() {
            if (userRole !== 'admin') {
                alert('Solo los administradores pueden eliminar fechas.');
                return;
            }
            var mesSeleccionado = parseInt(document.getElementById('mesSelector').value);
            var mat = db.meses[mesSeleccionado].materias.find(m => m.id === db.actual);
            if (!mat || mat.fechas.length === 0) {
                alert('No hay fechas para eliminar');
                return;
            }
            var opciones = mat.fechas.map((f, i) => `${i + 1}. ${f}`).join('\n');
            var seleccion = prompt('Selecciona el n√∫mero de la fecha a eliminar:\n\n' + opciones);
            if (seleccion) {
                var idx = parseInt(seleccion) - 1;
                if (idx >= 0 && idx < mat.fechas.length) {
                    if (confirm(`¬øEliminar "${mat.fechas[idx]}"?`)) {
                        mat.fechas.splice(idx, 1);

                        // Guardar en Firebase
                        database.ref(`meses/${mesSeleccionado}/materias`).set(db.meses[mesSeleccionado].materias);

                        render();
                    }
                } else {
                    alert('N√∫mero inv√°lido');
                }
            }
        }

        // Alternar la asistencia
        function toggleAsist(mid, aid, f) {
            if (userRole !== 'admin') {
                alert('Solo los administradores pueden modificar la asistencia.');
                return;
            }
            var mesSeleccionado = parseInt(document.getElementById('mesSelector').value);
            var mat = db.meses[mesSeleccionado].materias.find(m => m.id === mid);
            if (mat) {
                var al = mat.alumnos.find(a => a.id === aid);
                if (al) {
                    al.asist[f] = !al.asist[f];

                    // Guardar en Firebase
                    database.ref(`meses/${mesSeleccionado}/materias`).set(db.meses[mesSeleccionado].materias);

                    render();
                }
            }
        }

        // Actualizar observaciones
        function updateObservaciones(mid, aid, valor) {
            if (userRole !== 'admin') {
                alert('Solo los administradores pueden editar observaciones.');
                return;
            }
            var mesSeleccionado = parseInt(document.getElementById('mesSelector').value);
            var mat = db.meses[mesSeleccionado].materias.find(m => m.id === mid);
            if (mat) {
                var al = mat.alumnos.find(a => a.id === aid);
                if (al) {
                    al.observaciones = valor;

                    // Guardar en Firebase
                    database.ref(`meses/${mesSeleccionado}/materias`).set(db.meses[mesSeleccionado].materias);
                }
            }
        }

        // Cambiar tipo de materia
        function cambiarTipoMateria() {
            db.tipoMateriaActual = document.getElementById('tipoMateria').value;
            render();
        }

        // Cambiar mes
        function cambiarMes() {
            db.mesActual = parseInt(document.getElementById('mesSelector').value);
            db.actual = null;
            ocultarFormularioAlumno();
            render();
        }

        // Obtener estado del carnet
        function getEstadoCarnet(fechaVencimiento) {
            const hoy = new Date();
            const vencimiento = new Date(fechaVencimiento);
            const diffTime = vencimiento - hoy;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            if (diffDays < 0) {
                return { class: 'estado-rojo', text: 'Vencido' };
            } else if (diffDays <= 15) {
                return { class: 'estado-amarillo', text: 'Por vencer' };
            } else {
                return { class: 'estado-verde', text: 'Vigente' };
            }
        }

        // Renovar carnet
        function renovarCarnet(mid, aid) {
            if (userRole !== 'admin') {
                alert('Solo los administradores pueden renovar carnets.');
                return;
            }
            var mesSeleccionado = parseInt(document.getElementById('mesSelector').value);
            var mat = db.meses[mesSeleccionado].materias.find(m => m.id === mid);
            if (mat) {
                var al = mat.alumnos.find(a => a.id === aid);
                if (al) {
                    let unAnoDespues = new Date();
                    unAnoDespues.setFullYear(unAnoDespues.getFullYear() + 1);
                    al.fecha_vencimiento_carnet = unAnoDespues.toISOString().split('T')[0];

                    // Guardar en Firebase
                    database.ref(`meses/${mesSeleccionado}/materias`).set(db.meses[mesSeleccionado].materias);

                    render();
                }
            }
        }

        // Mostrar modal para editar alumno
        function mostrarModalEditarAlumno(aid) {
            if (userRole !== 'admin') {
                alert('Solo los administradores pueden editar alumnos.');
                return;
            }
            var mesSeleccionado = parseInt(document.getElementById('mesSelector').value);
            var mat = db.meses[mesSeleccionado].materias.find(m => m.id === db.actual);
            if (mat) {
                var al = mat.alumnos.find(a => a.id === aid);
                if (al) {
                    db.alumnoAEditar = al;
                    document.getElementById('editNombre').value = al.nombre;
                    document.getElementById('editApellido').value = al.apellido;
                    document.getElementById('editDNI').value = al.dni;
                    document.getElementById('editPabellon').value = al.pabellon;
                    document.getElementById('editFechaInscripcion').value = al.fecha_inscripcion;
                    document.getElementById('editFechaVencimiento').value = al.fecha_vencimiento_carnet;
                    document.getElementById('modalEditarAlumno').style.display = 'block';
                }
            }
        }

        // Guardar edici√≥n de alumno
        function guardarEdicionAlumno() {
            var n = document.getElementById('editNombre').value.trim();
            var a = document.getElementById('editApellido').value.trim();
            var d = document.getElementById('editDNI').value.trim();
            var p = document.getElementById('editPabellon').value.trim();
            var fi = document.getElementById('editFechaInscripcion').value;
            var fv = document.getElementById('editFechaVencimiento').value;
            if (!n || !a || !d || !p || !fi || !fv) {
                alert('Completa todos los campos');
                return;
            }
            var mesSeleccionado = parseInt(document.getElementById('mesSelector').value);
            var alumno = db.alumnoAEditar;
            alumno.nombre = n;
            alumno.apellido = a;
            alumno.dni = d;
            alumno.pabellon = p;
            alumno.fecha_inscripcion = fi;
            alumno.fecha_vencimiento_carnet = fv;
            db.meses[mesSeleccionado].materias.forEach(m => {
                var al = m.alumnos.find(a => a.id === alumno.id);
                if (al) {
                    al.nombre = n;
                    al.apellido = a;
                    al.dni = d;
                    al.pabellon = p;
                    al.fecha_inscripcion = fi;
                    al.fecha_vencimiento_carnet = fv;
                }
            });

            // Guardar en Firebase
            database.ref(`meses/${mesSeleccionado}`).set(db.meses[mesSeleccionado]);

            cerrarModal('modalEditarAlumno');
            render();
        }

        // Renderizar contenido
        function render() {
            if (userRole === 'admin') {
                document.getElementById('btnNuevaMateria').style.display = 'block';
                document.getElementById('btnNuevoAlumno').style.display = 'block';
                document.getElementById('logoutBtn').style.display = 'block';
            } else {
                document.getElementById('btnNuevaMateria').style.display = 'none';
                document.getElementById('btnNuevoAlumno').style.display = 'none';
                document.getElementById('logoutBtn').style.display = 'none';
            }
            var mesSeleccionado = parseInt(document.getElementById('mesSelector').value);
            var tipoSeleccionado = document.getElementById('tipoMateria').value;
            var materiasMesActual = db.meses[mesSeleccionado] ? db.meses[mesSeleccionado].materias : [];
            var materiasFiltradas = materiasMesActual.filter(m => m.tipo === tipoSeleccionado);
            var materiasHtml = '';
            materiasFiltradas.forEach(m => {
                materiasHtml += `
                    <div class="materia-item">
                        <button class="materia-btn ${db.actual === m.id ? 'active' : ''}" onclick="verMateria(${m.id})">${m.nombre}</button>
                        ${userRole === 'admin' ? `<button class="delete-materia" onclick="mostrarModalEliminarMateria(${m.id})">√ó</button>` : ''}
                    </div>
                `;
            });
            document.getElementById('materiasList').innerHTML = materiasHtml;
            renderContent();
        }

        // Renderizar contenido principal
        function renderContent() {
            var mesSeleccionado = parseInt(document.getElementById('mesSelector').value);
            var materiasMesActual = db.meses[mesSeleccionado] ? db.meses[mesSeleccionado].materias : [];
            if (materiasMesActual.length === 0 || !db.actual) {
                document.getElementById('mainArea').innerHTML = `
                    <div style="text-align: center; padding: 1.5rem; color: var(--text-secondary);">
                        <p>üìö <strong>Crea una materia para comenzar</strong> üìö</p>
                        <p>Haz clic en "<strong>Nueva Materia</strong>"</p>
                    </div>
                `;
                return;
            }
            var mat = db.meses[mesSeleccionado].materias.find(m => m.id === db.actual);
            if (!mat) return;
            var html = `
                <h2 style="color: var(--accent); text-align: center; margin-bottom: 1rem; font-size: 1.5rem;">üìñ ${mat.nombre}</h2>
            `;
            if (userRole === 'admin') {
                html += `
                    <div style="display: flex; gap: 0.75rem; margin-bottom: 1rem;">
                        <input type="text" id="ff" placeholder="Nueva fecha/clase" style="flex: 1; padding: 0.5rem; border-radius: 0.5rem; border: 1px solid #475569; background-color: #2d3748; color: var(--text-primary);">
                        <button class="btn btn-success" onclick="addFecha()">‚ûï Agregar</button>
                        <button class="btn btn-danger" onclick="deleteFecha()">üóëÔ∏è Eliminar</button>
                    </div>
                `;
            }
            if (!mat.alumnos || mat.alumnos.length === 0) {
                html += '<div style="text-align: center; padding: 1.5rem; color: var(--text-secondary);">No hay alumnos registrados en esta materia.</div>';
            } else {
                html += `
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Nombre</th>
                                    <th>Apellido</th>
                                    <th>DNI</th>
                                    <th>Pabell√≥n</th>
                                    <th>Inscripci√≥n</th>
                                    <th>Vencimiento</th>
                                    <th>Estado</th>
                                    ${mat.fechas ? mat.fechas.map(f => `<th>${f}</th>`).join('') : ''}
                                    <th>Observaciones</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                mat.alumnos.forEach(al => {
                    const estado = getEstadoCarnet(al.fecha_vencimiento_carnet);
                    html += `
                        <tr>
                            <td><strong>${al.nombre}</strong></td>
                            <td>${al.apellido}</td>
                            <td>${al.dni}</td>
                            <td>${al.pabellon}</td>
                            <td>${al.fecha_inscripcion}</td>
                            <td>${al.fecha_vencimiento_carnet}</td>
                            <td>
                                <span style="display: inline-block; width: 0.6rem; height: 0.6rem; border-radius: 50%; background-color: ${estado.class === 'estado-rojo' ? 'var(--danger)' : estado.class === 'estado-amarillo' ? 'var(--warning)' : 'var(--success)'};"></span>
                                ${estado.text}
                            </td>
                    `;
                    if (mat.fechas) {
                        mat.fechas.forEach(f => {
                            var chk = al.asist && al.asist[f] ? 'checked' : '';
                            var ico = al.asist && al.asist[f] ? '‚úÖ' : '‚ùå';
                            html += `
                                <td>
                                    <div style="display: flex; align-items: center; gap: 0.3rem;">
                                        <input type="checkbox" ${chk} ${userRole === 'admin' ? `onclick="toggleAsist(${mat.id}, ${al.id}, '${f}')"` : 'disabled'}>
                                        <span style="font-size: 0.8rem;">${ico}</span>
                                    </div>
                                </td>
                            `;
                        });
                    }
                    html += `
                            <td>
                                <textarea
                                    style="width: 100%; padding: 0.4rem; border-radius: 0.375rem; border: 1px solid #475569; background-color: #2d3748; color: var(--text-primary); resize: vertical; min-height: 2rem; font-size: 0.8rem;"
                                    placeholder="Observaciones..."
                                    ${userRole === 'admin' ? `onchange="updateObservaciones(${mat.id}, ${al.id}, this.value)"` : 'readonly'}
                                >${al.observaciones || ''}</textarea>
                            </td>
                            <td>
                                ${userRole === 'admin' ? `
                                    <div style="display: flex; flex-direction: column; gap: 0.3rem;">
                                        <button class="btn btn-warning" style="font-size: 0.7rem; padding: 0.3rem;" onclick="renovarCarnet(${mat.id}, ${al.id})">Renovar</button>
                                        <button class="btn btn-primary" style="font-size: 0.7rem; padding: 0.3rem;" onclick="mostrarModalEditarAlumno(${al.id})">Editar</button>
                                        <button class="btn btn-danger" style="font-size: 0.7rem; padding: 0.3rem;" onclick="delAlumno(${mat.id}, ${al.id})">Eliminar</button>
                                    </div>
                                ` : ''}
                            </td>
                        </tr>
                    `;
                });
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
            }
            document.getElementById('mainArea').innerHTML = html;
        }

        // Cambiar pesta√±a
        function cambiarPestania(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            document.querySelector(`.tab[onclick="cambiarPestania('${tab}')"]`).classList.add('active');
            document.getElementById(tab).classList.remove('hidden');
            if (tab === 'estadisticas') {
                cargarMateriasEstadisticas();
            }
        }

        // Cargar materias en el selector de estad√≠sticas
        function cargarMateriasEstadisticas() {
            const semestreSeleccionado = document.getElementById('estadisticasSemestreSelector').value;
            const tipoMateria = document.getElementById('estadisticasTipoMateria').value;
            let meses;
            if (semestreSeleccionado === 'primer') {
                meses = [0, 1, 2, 3, 4, 5]; // Enero a Junio
            } else {
                meses = [6, 7, 8, 9, 10, 11]; // Julio a Diciembre
            }
            let materias = [];
            meses.forEach(mesIndex => {
                if (db.meses[mesIndex]) {
                    materias = materias.concat(db.meses[mesIndex].materias.filter(m => m.tipo === tipoMateria));
                }
            });
            let options = '<option value="">Selecciona una materia</option>';
            materias.forEach(materia => {
                options += `<option value="${materia.id}">${materia.nombre}</option>`;
            });
            document.getElementById('estadisticasMateriaSelector').innerHTML = options;
            cargarEstadisticas();
        }

        // Calcular estad√≠sticas
        function calcularEstadisticas(materiaId) {
            const semestreSeleccionado = document.getElementById('estadisticasSemestreSelector').value;
            let meses;
            if (semestreSeleccionado === 'primer') {
                meses = [0, 1, 2, 3, 4, 5]; // Enero a Junio
            } else {
                meses = [6, 7, 8, 9, 10, 11]; // Julio a Diciembre
            }
            let totalAsistencias = 0;
            let totalFaltas = 0;
            let totalClases = 0;
            let estadisticasPorAlumno = {};
            let alumnos = {};
            meses.forEach(mesIndex => {
                if (db.meses[mesIndex]) {
                    const materiasMes = db.meses[mesIndex].materias;
                    const materia = materiasMes.find(m => m.id === materiaId);
                    if (materia) {
                        totalClases += materia.fechas ? materia.fechas.length : 0;
                        if (materia.alumnos) {
                            materia.alumnos.forEach(alumno => {
                                if (!alumnos[alumno.id]) {
                                    alumnos[alumno.id] = {
                                        nombre: `${alumno.nombre} ${alumno.apellido}`,
                                        dni: alumno.dni,
                                        pabellon: alumno.pabellon,
                                        asistencias: 0,
                                        faltas: 0
                                    };
                                }
                                if (materia.fechas) {
                                    materia.fechas.forEach(fecha => {
                                        if (alumno.asist && alumno.asist[fecha]) {
                                            alumnos[alumno.id].asistencias++;
                                            totalAsistencias++;
                                        } else {
                                            alumnos[alumno.id].faltas++;
                                            totalFaltas++;
                                        }
                                    });
                                }
                            });
                        }
                    }
                }
            });
            let estadisticasPorAlumnoArray = [];
            for (let alumnoId in alumnos) {
                const alumno = alumnos[alumnoId];
                const porcentajeAsistencia = totalClases > 0 ? Math.round((alumno.asistencias / totalClases) * 100) : 0;
                estadisticasPorAlumnoArray.push({
                    id: alumnoId,
                    nombre: alumno.nombre,
                    dni: alumno.dni,
                    pabellon: alumno.pabellon,
                    asistencias: alumno.asistencias,
                    faltas: alumno.faltas,
                    porcentajeAsistencia
                });
            }
            let porcentajeGeneral = totalClases * Object.keys(alumnos).length > 0
                ? Math.round((totalAsistencias / (totalClases * Object.keys(alumnos).length)) * 100)
                : 0;
            return {
                totalAsistencias,
                totalFaltas,
                porcentajeGeneral,
                estadisticasPorAlumno: estadisticasPorAlumnoArray
            };
        }

        // Mostrar estad√≠sticas
        function mostrarEstadisticas(estadisticas) {
            let html = `
                <div class="stats-container">
                    <div class="stat-card" style="background: linear-gradient(135deg, var(--accent), #5856eb);">
                        <h4>Asistencias Totales</h4>
                        <p>${estadisticas.totalAsistencias}</p>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, var(--danger), #dc2626);">
                        <h4>Faltas Totales</h4>
                        <p>${estadisticas.totalFaltas}</p>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, var(--success), #0d9488);">
                        <h4>% Asistencia General</h4>
                        <p>${estadisticas.porcentajeGeneral}%</p>
                    </div>
                </div>
                <h3 style="color: var(--accent); margin-bottom: 0.75rem; font-size: 1.2rem;">Listado de Alumnos</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>DNI</th>
                                <th>Pabell√≥n</th>
                                <th>Asistencias</th>
                                <th>Faltas</th>
                                <th>% Asistencia</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            estadisticas.estadisticasPorAlumno.forEach(alumno => {
                html += `
                    <tr>
                        <td style="font-size: 0.8rem;">${alumno.nombre}</td>
                        <td style="font-size: 0.8rem;">${alumno.dni}</td>
                        <td style="font-size: 0.8rem;">${alumno.pabellon}</td>
                        <td style="font-size: 0.8rem;">${alumno.asistencias}</td>
                        <td style="font-size: 0.8rem;">${alumno.faltas}</td>
                        <td style="font-size: 0.8rem;">${alumno.porcentajeAsistencia}%</td>
                    </tr>
                `;
            });
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            document.getElementById('estadisticasContainer').innerHTML = html;
        }

        // Cargar estad√≠sticas
        function cargarEstadisticas() {
            const materiaSeleccionadaId = parseInt(document.getElementById('estadisticasMateriaSelector').value);
            if (materiaSeleccionadaId) {
                const estadisticas = calcularEstadisticas(materiaSeleccionadaId);
                mostrarEstadisticas(estadisticas);
            }
        }
    </script>
</body>
</html>





